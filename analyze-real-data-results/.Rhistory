colour = "grey70",
linewidth = 0.2
) +
# vertical boundary lines at gene starts
geom_vline(
data = gene_bounds,
aes(xintercept = start),
inherit.aes = FALSE,
linetype = "dashed",
linewidth = 0.3,
colour = "grey40"
) +
# mosaic: each sequence is now a band, not a single line
geom_rect(
aes(
xmin = start,
xmax = end,
ymin = ymin,
ymax = ymax,
fill = lineage_segment
),
colour = NA
) +
# rotated gene labels ONLY on bottom facet
geom_text(
data = gene_labels_df,
aes(
x = mid,
y = -0.05,
label = gene
),
angle = 90,
hjust = 1,
vjust = 0.5,
size = 3
) +
facet_wrap(
~ parent_pair,
ncol = 1,
labeller = as_labeller(function(x) gsub("--", "-", x))  # em dash
) +
# y from -0.15 to 1.05 in every facet, plus a bit of space for labels
scale_y_continuous(limits = c(-0.15, 1.05), expand = c(0, 0)) +
coord_cartesian(clip = "off") +
labs(
x    = "Genome position (nt)",
y    = "Sequence index",
fill = "Local lineage"
) +
theme_bw() +
theme(
panel.grid       = element_blank(),
strip.background = element_rect(fill = "grey90"),
strip.text       = element_text(face = "bold"),
axis.text.y      = element_blank(),
axis.ticks.y     = element_blank(),
plot.margin      = margin(t = 10, r = 10, b = 40, l = 10)
)
p_mosaic
ggsave("figs/mosaic.png", p_mosaic, height = 7, width = 10)
## 4. Scaled mosaic plot with gene bands and labels
## 4.1 Rescale y and define band height per sequence ------------------------
segments_df_scaled <- segments_df %>%
group_by(parent_pair) %>%
mutate(
n_seq = n_distinct(seq_index),
# center position in [0,1] within each parent_pair
y = (seq_index - 0.5) / n_seq,
# band height: 0.8 of the available space, divided among sequences
h = 0.8 / n_seq,
ymin = y - h/2,
ymax = y + h/2
) %>%
ungroup()
# fix facet order and identify the last facet (bottom panel)
parent_levels <- unique(segments_df_scaled$parent_pair)
segments_df_scaled <- segments_df_scaled %>%
mutate(parent_pair = factor(parent_pair, levels = parent_levels))
last_parent <- tail(levels(segments_df_scaled$parent_pair), 1)
# labels only appear in bottom facet
gene_labels_df <- gene_bounds %>%
mutate(parent_pair = last_parent)
## 4.2 Plot -----------------------------------------------------------------
p_mosaic <- ggplot(segments_df_scaled) +
# gene bands in the background (all facets)
geom_rect(
data = gene_bounds,
aes(
xmin = start,
xmax = end,
ymin = -Inf,
ymax = Inf
),
inherit.aes = FALSE,
fill = "grey95",
alpha = 0.8,
colour = "grey70",
linewidth = 0.2
) +
# vertical boundary lines at gene starts
geom_vline(
data = gene_bounds,
aes(xintercept = start),
linetype = "dashed",
linewidth = 0.3,
colour = "grey40"
) +
# mosaic: each sequence is now a band, not a single line
geom_rect(
aes(
xmin = start,
xmax = end,
ymin = ymin,
ymax = ymax,
fill = lineage_segment
),
colour = NA
) +
# rotated gene labels ONLY on bottom facet
geom_text(
data = gene_labels_df,
aes(
x = mid,
y = -0.05,
label = gene
),
inherit.aes = FALSE,
angle = 90,
hjust = 1,
vjust = 0.5,
size = 3
) +
facet_wrap(
~ parent_pair,
ncol = 1,
labeller = as_labeller(function(x) gsub("--", "-", x))  # em dash
) +
# y from -0.15 to 1.05 in every facet, plus a bit of space for labels
scale_y_continuous(limits = c(-0.15, 1.05), expand = c(0, 0)) +
coord_cartesian(clip = "off") +
labs(
x    = "Genome position (nt)",
y    = "Sequence index",
fill = "Local lineage"
) +
theme_bw() +
theme(
panel.grid       = element_blank(),
strip.background = element_rect(fill = "grey90"),
strip.text       = element_text(face = "bold"),
axis.text.y      = element_blank(),
axis.ticks.y     = element_blank(),
plot.margin      = margin(t = 10, r = 10, b = 40, l = 10)
)
p_mosaic
ggsave("figs/mosaic.png", p_mosaic, height = 7, width = 10)
View(segments_df_scaled)
summarize(count = n())
# Confirm number of sequences with each target pair
pair_counts_during_ons %>% filter(
parent_pair %in% c("BQ.1.1--CH.1.1",
"BA.1.1--BA.2",
"CH.1.1--XBB.1.5")) %>%
group_by(parent_pair) %>%
summarize(count = n())
# Confirm number of sequences with each target pair
pair_counts_during_ons %>%
mutate(
# order-invariant parent pair
parent_pair = paste(pmin(parent1, parent2),
pmax(parent1, parent2),
sep = "--")) %>%
filter(
parent_pair %in% c("BQ.1.1--CH.1.1",
"BA.1.1--BA.2",
"CH.1.1--XBB.1.5")) %>%
group_by(parent_pair) %>%
summarize(count = n())
View(pair_counts_during_ons)
# Confirm number of sequences with each target pair
pair_counts_during_ons %>%
mutate(
# order-invariant parent pair
parent_pair = paste(pmin(parent1, parent2),
pmax(parent1, parent2),
sep = "--")) %>%
filter(
parent_pair %in% c("BQ.1.1--CH.1.1",
"BA.1.1--BA.2",
"CH.1.1--XBB.1.5")) %>%
group_by(parent_pair) %>%
summarize(count = n())
# Confirm number of sequences with each target pair
test <- pair_counts_during_ons %>%
mutate(
# order-invariant parent pair
parent_pair = paste(pmin(parent1, parent2),
pmax(parent1, parent2),
sep = "--")) %>%
filter(
parent_pair %in% c("BQ.1.1--CH.1.1",
"BA.1.1--BA.2",
"CH.1.1--XBB.1.5")) %>%
group_by(parent_pair) %>%
summarize(count = n())
View(test)
p_mosaic <- ggplot(segments_df_scaled) +
# gene bands in the background (all facets)
geom_rect(
data = gene_bounds,
aes(
xmin = start,
xmax = end,
ymin = -Inf,
ymax = Inf
),
inherit.aes = FALSE,
fill = "grey95",
alpha = 0.8,
colour = "grey70",
linewidth = 0.2
) +
# vertical boundary lines at gene starts
geom_vline(
data = gene_bounds,
aes(xintercept = start),
linetype = "dashed",
linewidth = 0.3,
colour = "grey40"
) +
# mosaic: each sequence is now a band, not a single line
geom_rect(
aes(
xmin = start,
xmax = end,
ymin = ymin,
ymax = ymax,
fill = lineage_segment
),
colour = NA
) +
# rotated gene labels ONLY on bottom facet
geom_text(
data = gene_labels_df,
aes(
x = mid,
y = -0.05,
label = gene
),
inherit.aes = FALSE,
angle = 90,
hjust = 1,
vjust = 0.5,
size = 3
) +
facet_wrap(
~ parent_pair,
ncol = 1,
labeller = as_labeller(function(x) gsub("--", "-", x))  # em dash
) +
# y from -0.15 to 1.05 in every facet, plus a bit of space for labels
scale_y_continuous(limits = c(-0.15, 1.05), expand = c(0, 0)) +
coord_cartesian(clip = "off") +
labs(
x    = "Genome position (nt)",
y    = "Sequence index",
fill = "Local Pango lineage ancestry"
) +
theme_bw() +
theme(
panel.grid       = element_blank(),
strip.background = element_rect(fill = "grey90"),
strip.text       = element_text(face = "bold"),
axis.text.y      = element_blank(),
axis.ticks.y     = element_blank(),
plot.margin      = margin(t = 10, r = 10, b = 40, l = 10)
)
p_mosaic
ggsave("figs/mosaic.png", p_mosaic, height = 7, width = 10)
library(tidyverse)
library(stringr)
library(readr)
library(purrr)
library(data.table)
# Inferred
res <- read.csv("summary_files/combined_optimization_results_with_summary.csv") %>%
mutate(across(c(test_start, test_end), as.Date)) %>%
mutate(date = test_start + (test_end - test_start) / 2)
# add number of parental lineages
res_w_n_parents <- res %>%
mutate(
n_parents = case_when(
is.na(parental_lineages) | parental_lineages == "" ~ 0L,
TRUE ~ str_count(parental_lineages, fixed(";")) + 1L
)
)
# counts
n_three_or_more <- sum(res_w_n_parents$n_parents >= 3, na.rm = TRUE)
n_one_only      <- sum(res_w_n_parents$n_parents == 1, na.rm = TRUE)
# filtered data: keep exactly 2 parental lineages
res_filtered <- res_w_n_parents %>%
filter(n_parents == 2) %>%
select(-n_parents)
#
tally_parents <- res_w_n_parents %>%
count(n_parents, name = "n_rows") %>%
arrange(n_parents)
# Compute numerator and denominator
num <- nrow(res_filtered)
den <- sum(tally_parents$n_rows[-1])
# Exact (Clopper–Pearson) binomial CI
bt <- binom.test(num, den)
bt$estimate   # estimated proportion
bt$conf.int   # exact 95% Clopper–Pearson CI
View(tally_parents)
library(tidyverse)
library(scales)
library(data.table)
# ── Inferred recombinants ─────────────────────────────────────────────────────
res <- read.csv("summary_files/combined_optimization_results_with_summary.csv") %>%
mutate(across(c(test_start, test_end), as.Date)) %>%
mutate(date       = test_start + (test_end - test_start) / 2)
res_pairs <- res %>%
add_count(date, name = "n_samples") %>%          # <- adds n_samples per date
filter(str_count(parental_lineages, ";") >= 1) %>%
group_by(date, test_start, test_end, n_samples) %>%                    # keep n_samples in the key
summarise(n_inferred = n(), .groups = "drop")
# Exact binomial CIs ⇒ *count* scale
ci_exact <- function(k, n) binom.test(k, n)$conf.int
summary_df <- res_pairs %>%
mutate(
ci_lo       = map2_dbl(n_inferred, n_samples, ~ ci_exact(.x, .y)[1] * .y),
ci_hi       = map2_dbl(n_inferred, n_samples, ~ ci_exact(.x, .y)[2] * .y),
ci_prop_lo  = map2_dbl(n_inferred, n_samples, ~ ci_exact(.x, .y)[1]),
ci_prop_hi  = map2_dbl(n_inferred, n_samples, ~ ci_exact(.x, .y)[2])
)
summary_df$prop <- summary_df$n_inferred/summary_df$n_samples
windows <- summary_df %>% select(test_start, test_end)
# Read and prepare ONS data
ons <- read.table("../data/ons_survey_data.tsv")
ons <- ons %>%
transmute(
day   = V1, month_name = V2, year = V3, percent = V4,
prop  = percent / 100,
date  = as.Date(paste(year, month_name, day, sep = "-"), format = "%Y-%B-%d")
)
setDT(windows)
windows[, `:=`(test_start = as.Date(test_start), test_end = as.Date(test_end))]
setDT(ons)
ons[, `:=`(start = date, end = date)]
setkey(ons, start, end)
setkey(windows, test_start, test_end)
ans <- foverlaps(
x = ons, y = windows,
by.x = c("start","end"),
by.y = c("test_start","test_end"),
type = "within",      # date within [test_start, test_end]
nomatch = 0L
)[
, .(avg_prop = mean(prop, na.rm = TRUE),
n_days  = .N),
by = .(test_start, test_end)
]
# testing
ons_second_win <- ons %>% filter(day >= 14, day <= 20, month_name == "September", year == 2020)
mean(ons_second_win$percent)
# proportion matches
summary_df <- summary_df %>%
left_join(
ans %>% select(test_start, ons_prop = avg_prop),
by = "test_start"
)
# (Optional) set a global theme to keep all plots consistent
theme_set(theme_bw(base_size = 16))
p_prev <- ggplot(summary_df, aes(x = date)) +
# CI ribbon for 'prop'
geom_ribbon(
aes(x = date, ymin = ci_prop_lo, ymax = ci_prop_hi),
inherit.aes = FALSE,
data = summary_df,
alpha = 0.3,
fill = "grey60",
colour = NA
) +
# 'prop' line + faint points
geom_line(aes(y = prop, linetype = "Estimated recombinant proportion"), linewidth = 0.9) +
geom_point(aes(y = prop), alpha = 0.10, size = 1.2, stroke = 0, show.legend = FALSE) +
# ONS line (dashed)
geom_line(aes(y = ons_prop, linetype = "ONS SARS-CoV-2 prevalence"), linewidth = 0.9) +
# Scales
scale_y_continuous(labels = label_percent(accuracy = 0.1), limits = c(0, NA)) +
scale_x_date(date_breaks = "1 week", date_labels = "%Y-%m-%d", expand = expansion(mult = c(0.01, 0.01))) +
scale_linetype_manual(
name = NULL,
values = c("Estimated recombinant proportion" = "solid", "ONS SARS-CoV-2 prevalence" = "22")  # dashed
) +
labs(
x = "Date",
y = "Recombinant proportion"
) +
guides(linetype = guide_legend(override.aes = list(color = "black"))) +
theme(
legend.position = "top",
axis.text.x = element_text(angle = 45, hjust = 1)
)
library(lubridate)
month_starts <- seq(
floor_date(min(summary_df$date, na.rm = TRUE), "month"),
ceiling_date(max(summary_df$date, na.rm = TRUE), "month"),
by = "2 months"
)
p_prev <- p_prev +
scale_x_date(
breaks = month_starts,           # ticks at the 1st of each month
date_labels = "%Y-%m",
expand = expansion(mult = c(0.01, 0.01))
) +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
p_prev
# Okabe–Ito palette (colorblind-safe)
okabe4 <- c("#009E73", "#56B4E9", "#D55E00", "#CC79A7")
delta <- 0   # e.g., 0.5 percentage points
k <- 4        # "more than a few windows" = 3+
# Identify qualifying runs
runs <- summary_df %>%
arrange(date) %>%
mutate(diff = ons_prop - prop,
flag = diff > delta,
run_id = cumsum(flag != dplyr::lag(flag, default = first(flag)))) %>%
group_by(run_id) %>%
summarise(flag  = first(flag),
n     = dplyr::n(),
start = min(date),
end   = max(date),
.groups = "drop") %>%
filter(flag, n >= k) %>%
arrange(start)
# Exclude some intervals
runs <- runs %>% filter(run_id %in% c(3,9,11,15))
# Assign colors (using viridis palette)
runs$fill_color <- okabe4[seq_along(runs$run_id)]
# Add background rectangles (no legend)
p_prev_colored <- p_prev +
geom_rect(
data = runs,
aes(xmin = start, xmax = end, ymin = -Inf, ymax = Inf),
inherit.aes = FALSE,
fill = runs$fill_color,
alpha = 0.18
)
p_prev_colored
ggsave("figs/line_plot.png", p_prev_colored, width = 9, height = 6, dpi = 300)
# Pearson correlation (same as before)
ct <- cor.test(summary_df$prop, summary_df$ons_prop, use = "complete.obs", method = "pearson")
r_val <- unname(ct$estimate)
p_val <- ct$p.value
n_obs <- sum(complete.cases(summary_df[, c("prop", "ons_prop")]))
cap_text <- sprintf("Pearson correlation r = %.3f (p = %.3g), n = %d",
r_val, p_val, n_obs)
# Common axis limit (0 to shared max)
lim_max <- max(summary_df$prop, summary_df$ons_prop, na.rm = TRUE)
if (nrow(runs) > 0) {
for (i in seq_len(nrow(runs))) {
idx <- summary_df$date >= runs$start[i] & summary_df$date <= runs$end[i]
summary_df$fill_color[idx] <- runs$fill_color[i]
}
}
summary_df$fill_color[is.na(summary_df$fill_color)] <- "grey80"
# (Re)build plot if needed; assumes you already computed lim_max and p_scatter structure
p_scatter <- ggplot(summary_df, aes(x = ons_prop, y = prop)) +
geom_point(aes(color = fill_color), alpha = 0.6, size = 1.8, stroke = 0) +
scale_color_identity(guide = "none") +
geom_abline(slope = 1, intercept = 0, linewidth = 0.6, color = "black") +
scale_x_continuous(labels = label_percent(accuracy = 0.1),
limits = c(0, lim_max),
expand = expansion(mult = c(0, 0.01))) +
scale_y_continuous(labels = label_percent(accuracy = 0.1),
limits = c(0, lim_max),
expand = expansion(mult = c(0, 0.01))) +
labs(
x = "ONS SARS-CoV-2 prevalence",
y = "Recombinant proportion",
caption = cap_text
) +
coord_equal() +
theme(legend.position = "none")
# Prefer ggrepel if available
# if (requireNamespace("ggrepel", quietly = TRUE)) {
#   library(ggrepel)
#   p_scatter <- p_scatter +
#     geom_text_repel(
#       data = lab_df,
#       aes(label = label_date),
#       size = 3,                      # small text
#       max.overlaps = Inf,
#       box.padding = 0.2,
#       point.padding = 0.1,
#       min.segment.length = 0
#     )
# } else {
#   # Fallback without ggrepel
#   p_scatter <- p_scatter +
#     geom_text(
#       data = lab_df,
#       aes(label = label_date),
#       size = 3,
#       nudge_x = 0.005, nudge_y = 0.005,  # small nudges so text isn't on top of the point
#       check_overlap = TRUE
#     )
# }
p_scatter
ggsave("figs/scatter_prop_vs_ons.png", p_scatter, width = 6, height = 6, dpi = 300)
