---
title: "time_series_simple"
output: html_document
date: "2025-07-13"
---

```{r setup, include=FALSE}
library(tidyverse)
library(scales)
library(data.table)

# ── Inferred recombinants ─────────────────────────────────────────────────────
res <- read.csv("summary_files/combined_optimization_results_with_summary.csv") %>%
  mutate(across(c(test_start, test_end), as.Date)) %>%
  mutate(date       = test_start + (test_end - test_start) / 2)

res_pairs <- res %>%
  add_count(date, name = "n_samples") %>%          # <- adds n_samples per date
  filter(str_count(parental_lineages, ";") >= 1) %>%
  group_by(date, test_start, test_end, n_samples) %>%                    # keep n_samples in the key
  summarise(n_inferred = n(), .groups = "drop")

# Exact binomial CIs ⇒ *count* scale
ci_exact <- function(k, n) binom.test(k, n)$conf.int

summary_df <- res_pairs %>%
  mutate(
    ci_lo       = map2_dbl(n_inferred, n_samples, ~ ci_exact(.x, .y)[1] * .y),
    ci_hi       = map2_dbl(n_inferred, n_samples, ~ ci_exact(.x, .y)[2] * .y),
    ci_prop_lo  = map2_dbl(n_inferred, n_samples, ~ ci_exact(.x, .y)[1]),
    ci_prop_hi  = map2_dbl(n_inferred, n_samples, ~ ci_exact(.x, .y)[2])
  )

summary_df$prop <- summary_df$n_inferred/summary_df$n_samples

windows <- summary_df %>% select(test_start, test_end)
```

```{r}
# Read and prepare ONS data 
ons <- read.table("../data/ons_survey_data.tsv")
ons <- ons %>%
  transmute(
    day   = V1, month_name = V2, year = V3, percent = V4,
    prop  = percent / 100,
    date  = as.Date(paste(year, month_name, day, sep = "-"), format = "%Y-%B-%d")
  )

setDT(windows)
windows[, `:=`(test_start = as.Date(test_start), test_end = as.Date(test_end))]

setDT(ons)
ons[, `:=`(start = date, end = date)]
setkey(ons, start, end)
setkey(windows, test_start, test_end)

ans <- foverlaps(
  x = ons, y = windows,
  by.x = c("start","end"),
  by.y = c("test_start","test_end"),
  type = "within",      # date within [test_start, test_end]
  nomatch = 0L
)[
  , .(avg_prop = mean(prop, na.rm = TRUE),
      n_days  = .N),
  by = .(test_start, test_end)
]

# testing
ons_second_win <- ons %>% filter(day >= 14, day <= 20, month_name == "September", year == 2020)
mean(ons_second_win$percent)

# proportion matches
summary_df <- summary_df %>%
  left_join(
    ans %>% select(test_start, ons_prop = avg_prop),
    by = "test_start"
  )
```

```{r}
# (Optional) set a global theme to keep all plots consistent
theme_set(theme_bw(base_size = 16))

p_prev <- ggplot(summary_df, aes(x = date)) +
  # CI ribbon for 'prop'
  geom_ribbon(
    aes(x = date, ymin = ci_prop_lo, ymax = ci_prop_hi),
    inherit.aes = FALSE,
    data = summary_df,
    alpha = 0.3,
    fill = "grey60",
    colour = NA
  ) +
  # 'prop' line + faint points
  geom_line(aes(y = prop, linetype = "Estimated recombinant proportion"), linewidth = 0.9) +
  geom_point(aes(y = prop), alpha = 0.10, size = 1.2, stroke = 0, show.legend = FALSE) +
  # ONS line (dashed)
  geom_line(aes(y = ons_prop, linetype = "ONS SARS-CoV-2 prevalence"), linewidth = 0.9) +
  # Scales
  scale_y_continuous(labels = label_percent(accuracy = 0.1), limits = c(0, NA)) +
  scale_x_date(date_breaks = "1 week", date_labels = "%Y-%m-%d", expand = expansion(mult = c(0.01, 0.01))) +
  scale_linetype_manual(
    name = NULL,
    values = c("Estimated recombinant proportion" = "solid", "ONS SARS-CoV-2 prevalence" = "22")  # dashed
  ) +
  labs(
    x = "Date",
    y = "Recombinant proportion"
  ) +
  guides(linetype = guide_legend(override.aes = list(color = "black"))) +
  theme(
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) 

library(lubridate)

month_starts <- seq(
  floor_date(min(summary_df$date, na.rm = TRUE), "month"),
  ceiling_date(max(summary_df$date, na.rm = TRUE), "month"),
  by = "2 months"
)

p_prev <- p_prev +
  scale_x_date(
    breaks = month_starts,           # ticks at the 1st of each month
    date_labels = "%Y-%m",
    expand = expansion(mult = c(0.01, 0.01))
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p_prev
```

```{r}
# Okabe–Ito palette (colorblind-safe)
okabe4 <- c("#009E73", "#56B4E9", "#D55E00", "#CC79A7")

delta <- 0   # e.g., 0.5 percentage points
k <- 4        # "more than a few windows" = 3+

# Identify qualifying runs
runs <- summary_df %>%
  arrange(date) %>%
  mutate(diff = ons_prop - prop,
         flag = diff > delta,
         run_id = cumsum(flag != dplyr::lag(flag, default = first(flag)))) %>%
  group_by(run_id) %>%
  summarise(flag  = first(flag),
            n     = dplyr::n(),
            start = min(date),
            end   = max(date),
            .groups = "drop") %>%
  filter(flag, n >= k) %>%
  arrange(start)

# Exclude some intervals
runs <- runs %>% filter(run_id %in% c(3,9,11,15))

# Assign colors (using viridis palette)
runs$fill_color <- okabe4[seq_along(runs$run_id)]

# Add background rectangles (no legend)
p_prev_colored <- p_prev +
  geom_rect(
    data = runs,
    aes(xmin = start, xmax = end, ymin = -Inf, ymax = Inf),
    inherit.aes = FALSE,
    fill = runs$fill_color,
    alpha = 0.18
  )

p_prev_colored

ggsave("figs/line_plot.png", p_prev_colored, width = 9, height = 6, dpi = 300)
```

```{r}
# Pearson correlation (same as before)
ct <- cor.test(summary_df$prop, summary_df$ons_prop, use = "complete.obs", method = "pearson")
r_val <- unname(ct$estimate)
p_val <- ct$p.value
n_obs <- sum(complete.cases(summary_df[, c("prop", "ons_prop")]))
cap_text <- sprintf("Pearson correlation r = %.3f (p = %.3g), n = %d",
                    r_val, p_val, n_obs)

# Common axis limit (0 to shared max)
lim_max <- max(summary_df$prop, summary_df$ons_prop, na.rm = TRUE)

if (nrow(runs) > 0) {
  for (i in seq_len(nrow(runs))) {
    idx <- summary_df$date >= runs$start[i] & summary_df$date <= runs$end[i]
    summary_df$fill_color[idx] <- runs$fill_color[i]
  }
}

summary_df$fill_color[is.na(summary_df$fill_color)] <- "grey80"

# (Re)build plot if needed; assumes you already computed lim_max and p_scatter structure
p_scatter <- ggplot(summary_df, aes(x = ons_prop, y = prop)) +
  geom_point(aes(color = fill_color), alpha = 0.6, size = 1.8, stroke = 0) +
  scale_color_identity(guide = "none") + 
  geom_abline(slope = 1, intercept = 0, linewidth = 0.6, color = "black") +
  scale_x_continuous(labels = label_percent(accuracy = 0.1),
                     limits = c(0, lim_max),
                     expand = expansion(mult = c(0, 0.01))) +
  scale_y_continuous(labels = label_percent(accuracy = 0.1),
                     limits = c(0, lim_max),
                     expand = expansion(mult = c(0, 0.01))) +
  labs(
    x = "ONS SARS-CoV-2 prevalence",
    y = "Recombinant proportion",
    caption = cap_text
  ) +
  coord_equal() +
  theme(legend.position = "none")

# Prefer ggrepel if available
# if (requireNamespace("ggrepel", quietly = TRUE)) {
#   library(ggrepel)
#   p_scatter <- p_scatter +
#     geom_text_repel(
#       data = lab_df,
#       aes(label = label_date),
#       size = 3,                      # small text
#       max.overlaps = Inf,
#       box.padding = 0.2,
#       point.padding = 0.1,
#       min.segment.length = 0
#     )
# } else {
#   # Fallback without ggrepel
#   p_scatter <- p_scatter +
#     geom_text(
#       data = lab_df,
#       aes(label = label_date),
#       size = 3,
#       nudge_x = 0.005, nudge_y = 0.005,  # small nudges so text isn't on top of the point
#       check_overlap = TRUE
#     )
# }

p_scatter
ggsave("figs/scatter_prop_vs_ons.png", p_scatter, width = 6, height = 6, dpi = 300)
```


